<?xml version="1.0" encoding="utf-8" ?>
<configuration>
  <!--
*****************************************************************************************************
 Config File: OrderLink_IRMA_Import.cfg
      Author: Ron Savage
        Date: 04/13/2009

 Description: 
 This file contains logic to insert DVO and O/L orders into IRMA OrderHeader table.

 Modification History: 
 Date       Init Comment
 03/03/2016 BJ/MU	Added Predictix Order Number from DVO table
 03/21/2013 RS   Updated SetID condtions to in ('WHOLE','WFMUK') to capture UK orders.
 02/28/2012 RS   Fixed JOIN to use b.inv_num instead of a.inv_num.
 02/03/2012 RS   Fixed condition to use b.last_update instead of a.last_update, and add b.status = 'INV'.
 01/27/2012 RS   Updated credits portion of the query to use the new last_update field added
                 by the DAS team.
 05/30/2011 DBS  Trim Price Decimal places to prevent error. TFS 1966
 03/19/2010 BR   Removed TimeZoneOffset key from query.
 03/10/2010 MY   Enabled for 3.6 using DataMonkey 2. Changed config filename from
                 DVO_OrderLink_IRMA_Import_WithParams.cfg to OrderLink_IRMA_Import.cfg
 01/12/2010 MY   Modified to contain only OrderLink Processing for NA/NE Stores
 10/07/2009 BR   Added revamped OL import query that now pulls by Order_Status and last_Stat_updt
                 Also added output of invoice information along with shipped quantity/weight
 09/25/2009 MY   Modified to accept parameters from IRMA AppConfig through a pivot query
 04/13/2009 RS   Created.
*****************************************************************************************************
-->

  <!--
*****************************************************************************************************
 Global Key Definitions
*****************************************************************************************************
-->
  <config key="conTimeout"      value="60"/>
  <config key="sqlTimeout"      value="120"/>
  <config key="emailSMTPServer" value="smtp.wholefoods.com"/>
  <config key="LogFile"         value="/IRMA/logs_test/{Reg}/OrderLink_IRMA_Import_{yyyy}{MM}{dd}.log"/>
  <config key="ParameterFile"   value="conf_test/{Reg}_OrderLink_IRMA_Import.prm"/>

  <config key="App"             value="DM - OL IMPORT JOB"/>

  <!-- Database Connection string keys -->
  <config key="OrderLink"       value="FILE:conn_test/OrderLink_Connection.txt"/>
  <config key="IRMA"            value="FILE:conn_test/{Reg}_IRMA_Connection.txt"/>

  <config key="arg-delim"       value="~"/>

  <config key="OL"              value="|"/>

  <!-- Include only orders from specific stores from OrderLink -->
  <config key="OL_include"      value="{OL_Include}"/>


  <!--
*****************************************************************************************************
 Source/Target Entries
*****************************************************************************************************
-->
  <config key="maxEntries"      value="1"/>
  <config key="source_1"        value="DB, OrderLink, QUERY, query1, OL, , , 1"/>
  <config key="target_1"        value="DB, IRMA, PROC, OrderLink_ImportOrder,,,, ERROR: "/>
  <config key="notify_1"        value="ol_error,ol_success"/>
  <config key="arguments_1"     value="DB, IRMA, QUERY, getArgs, arg-delim, , "/>

  <!--
*****************************************************************************************************
 Message Entries
*****************************************************************************************************
-->
  <config key="ol_success"      value="success_msg,Successfully Imported an OrderLink order,ol_import@wholefoods.com,{OL_Success_Email}"/>
  <config key="ol_error"        value="error_msg,Error importing an OrderLink order ,ol_import@wholefoods.com,{OL_Error_Email}"/>

  <config key="success_msg"     value="FILE:conf_test/success_msg.htm"/>
  <config key="error_msg"       value="FILE:conf_test/error_msg.htm"/>


  <!--
*****************************************************************************************************
 Query to get arguments
*****************************************************************************************************
-->
  <config key="getArgs"            value="
   declare @mySQL varchar(MAX);

      SET @mySQL = '
         SELECT
            a.Name          AppName,
            ace.ShortName   Environment,
            ack.Name        KeyName,
            acv.Value       KeyValue
         FROM
            AppConfigApp a

            INNER JOIN AppConfigEnv ace
                  ON (ace.EnvironmentId = a.EnvironmentId)

            INNER JOIN AppConfigValue acv
                  ON (acv.ApplicationId = a.ApplicationId)

            INNER JOIN AppConfigKey ack
                  ON (ack.KeyId = acv.KeyId)

         WHERE
            a.Name like ''{App}''
         AND
         ace.EnvironmentID = ''{Env}''
       AND
            acv.Deleted = 0
         AND 
            a.Deleted = 0
         AND
            ace.Deleted = 0
         AND 
            ack.Deleted = 0
         ';

      exec dbo.pivot_query @mySQL, 'AppName', 'KeyName', 'max(KeyValue)';
   "/>


  <!--
   *****************************************************************************************************
    O/L query
   *****************************************************************************************************
   -->
  <config key="query1" value="
      SELECT
         'Order'                                                     as OrderOrCredit,
         OH.Order_Number                                             as Order_Number,
         TO_CHAR(OH.Order_Date,'mm/dd/yyyy HH24:mi:ss')              as Order_Date,
         OH.DC_Business_Unit                                         as DC_Business_Unit,
         DECODE(OH.User_ID,'MSI',C.GL_Unit,SUBSTR(OH.Cust_ID,1,5))   as User_GL_Unit,
         C.GL_Unit                                                   as GL_Unit,
         OL.Order_Line_No                                            as Order_Line_No,
         OL.Item_Code                                                as Item_Code,
         OL.UPC_PLU                                                  as UPC_PLU,
         SUBSTR(OL.Description1,1,1000)                              as Item_Comments,
         OL.Order_Quantity                                           as Order_Quantity,
         OL.Std_UOM                                                  as Std_UOM,
         OL.Price                                                    as Price,
         OH.User_ID                                                  as BuyerUserID,
         TO_CHAR(OH.Ship_Date,'mm/dd/yyyy HH24:mi:ss')               as Ship_Date,
         W.Product                                                   as Product,
         IA.Qty_Ship                                                 as Qty_Ship,
         OL.CatchWeight_Flag                                         as CatchWeight_Flag,
         OL.Billed_Quantity                                          as LineItemWt,
         OL.Weight                                                   as Pack,
         CASE
            WHEN W.Account LIKE '510%' THEN 2 -- packaging
            ELSE
               CASE
                  WHEN W.Account LIKE '800%' THEN 3 -- Supplies
                  ELSE 1                            -- Product
               END
         END                                                         as Product_Type,

         (SELECT MIN(Order_Line_No)
          FROM tbl_Ord_Line Ord_Line
          WHERE Ord_Line.Order_Number = OH.Order_Number)             as Order_Item_Min,

         (SELECT MAX(Order_Line_No)
          FROM tbl_Ord_Line Ord_Line
          WHERE Ord_Line.Order_Number = OH.Order_Number)             as Order_Item_Max,

         (SELECT COUNT(Order_Line_No)
          FROM tbl_Ord_Line Ord_Line
          WHERE Ord_Line.Order_Number = OH.Order_Number)             as Order_Item_Count,
         IA.Ext_Amount                                               as Ext_Amount,
         IAT.Inv_Total                                               as Inv_Total,
         TO_CHAR(OH.Last_Stat_Updt,'mm/dd/yyyy HH24:mi:ss')          as FilterDate,
         ''                                                          as Credit_Reason,
         OH.Order_Status                                             as Order_Status,
         {OL_DCStore}                                                as OL_DCStore,
                  
         (SELECT pdx_no 
          FROM supplier.poheaders@{DVO_Link} 
          WHERE id = substr(OH.conf_num,2,9))                        as PDXOrderNumber
          
      FROM
         Word.tbl_Ord_Header OH

         JOIN Word.tbl_Ord_Line OL
            ON ( OL.Order_Number = OH.Order_Number )

         JOIN word.tbl_Customers C
            ON ( C.Cust_ID = OH.Cust_ID )

         JOIN ps_WFM_CustDef_Tbl_Syn W
            ON ( OH.Cust_ID = W.Cust_ID
                 AND W.SetID in ('WHOLE','WFMUK'))   -- To find Product_Type)

         LEFT OUTER JOIN tbl_Invoices_Active IA
            ON ( IA.Inv_Num = OL.Order_Number
                 AND IA.Line = OL.Order_Line_No )

         LEFT OUTER JOIN
            (
            SELECT
               Inv_Num         as Inv_Num,
               SUM(Ext_Amount) as Inv_Total
            FROM
               tbl_Invoices_Active
            GROUP BY
               Inv_Num
            ) IAT
            ON ( IAT.Inv_Num = OL.Order_Number )

      WHERE
         OL.Order_Quantity > 0
         AND OH.Last_Stat_Updt >= (TO_DATE('{LAST_SQL_START}','YYYY/MM/DD HH24:MI:SS'){Time_Zone_Offset})
         AND OH.Order_Status IN {OL_OrderStatus}
         AND OH.DC_Business_Unit IN {OL_DCList}

   UNION

      SELECT
         'Credit'                                                    as OrderOrCredit,
         b.order_number                                              as Order_Number,
         TO_CHAR(a.cr_req_date,'mm/dd/yyyy HH24:mi:ss')              as Order_Date,
         a.DC_Business_Unit                                          as DC_Business_Unit,
         DECODE(OH.User_ID,'MSI',Cus.GL_Unit,SUBSTR(OH.Cust_ID,1,5)) as User_GL_Unit,
         Cus.GL_Unit                                                 as GL_Unit,
         a.LINE                                                      as Order_Line_No,
         a.item_code                                                 as Item_Code,
         ''                                                          as UPC_PLU,
         a.cr_req_note                                               as Item_Comments,
         TO_NUMBER(a.cr_req_qty)                                     as Order_Quantity,
         OL.Std_UOM                                                  as Std_UOM,
         (a.cr_req_apprvd_amnt / a.cr_req_qty_apprvd)                as Price,
         TO_CHAR(a.cr_req_by)                                        as BuyerUserID,
         TO_CHAR(a.ship_date,'mm/dd/yyyy HH24:mi:ss')                as Ship_Date,
         d.Product                                                   as Product,
         a.cr_req_qty_apprvd                                         as Qty_Ship,
         OL.CatchWeight_Flag                                         as CatchWeight_Flag,
         TO_NUMBER(a.cr_req_qty)                                     as LineItemWt,
         OL.Weight                                                   as Pack,
         CASE
            WHEN d.Account LIKE '510%' THEN 2       -- Packaging
            ELSE
               CASE
                  WHEN d.Account LIKE '800%' THEN 3 -- Supplies
                  ELSE 1                            -- Product
               END
         END                                                         as Product_Type,

         (SELECT MIN(a_MIN.LINE)
          FROM TBL_INVOICES_ACTIVE a_MIN
          WHERE a_MIN.order_number = b.order_number)                 as Order_Item_Min,

         (SELECT MAX(a_MAX.LINE)
          FROM TBL_INVOICES_ACTIVE a_MAX
          WHERE a_MAX.order_number = b.order_number)                 as Order_Item_Max,

         (SELECT COUNT(a_CNT.LINE)
          FROM TBL_INVOICES_ACTIVE a_CNT
          WHERE a_CNT.order_number = b.order_number)                 as Order_Item_Count,

         a.Ext_Amount                                                as Ext_Amount,
         (IAT.Inv_Total * -1)                                        as Inv_Total,
         TO_CHAR(b.last_update,'mm/dd/yyyy HH24:mi:ss')              as FilterDate,
         a.cr_req_reason                                             as Credit_Reason,
         'B'                                                         as Order_Status,
         {OL_DCStore}                                                as OL_DCStore,
         
         (SELECT pdx_no 
          FROM supplier.poheaders@{DVO_Link} 
          WHERE id = substr(OH.conf_num,2,9))                        as PDXOrderNumber

      FROM
         TBL_INVOICES_ACTIVE a

         JOIN TBL_INVOICES_ACTIVE b
            ON ( a.inv_num = b.orig_inv
                 AND a.item_code = b.item_code )

         LEFT OUTER JOIN tbl_ord_header OH
            ON ( a.Inv_Num = OH.Order_Number )

         LEFT OUTER JOIN tbl_ord_line OL
            ON ( OH.Order_Number = OL.Order_Number
                AND a.Line = OL.Order_Line_No )

         LEFT OUTER JOIN ps_WFM_CustDef_Tbl_Syn d
            ON ( OH.Cust_ID = d.Cust_ID )

         LEFT OUTER JOIN tbl_Customers Cus
            ON ( OH.Cust_ID = Cus.Cust_ID )

         LEFT OUTER JOIN
            (
            SELECT
               Inv_Num            as Inv_Num,
               SUM(Ext_Amount)    as Inv_Total
            FROM
               tbl_Invoices_Active
            GROUP BY
               Inv_Num
            ) IAT
            ON ( IAT.Inv_Num = b.inv_num )

      WHERE
         a.dc_business_unit IN {OL_DCList}
         AND a.cr_req = 'TRUE'
         AND a.cr_req_status = 'APPROVED'
         AND b.status = 'INV'

--         AND c.add_dttm >= (TO_DATE('{LAST_SQL_START}','YYYY/MM/DD HH24:MI:SS'){Time_Zone_Offset})  -- old

         AND b.last_update >= (TO_DATE('{LAST_SQL_START}','YYYY/MM/DD HH24:MI:SS'){Time_Zone_Offset}) -- new

         AND d.SetID in ('WHOLE','WFMUK')

      ORDER BY
         1 DESC,
         2 DESC,
         7
   "/>

</configuration>
