<?xml version="1.0" encoding="utf-8" ?>
<configuration>
  <!--****************************************************************
 Config File: TestNutriChefToIRMA
      Author: trey.damico@wholefoods.com
        Date: 08/27/2013

 Description: 
 to pull nutrifact data from Nutrichef into IRMA

 Modification History: 
 Date       Init Comment
 08/27/2013 DM   Created.
******************************************************************-->

  <!--********************************************************************
 Deployment Key Definitions - * keys are enabled
********************************************************************-->
  <!-- *test or dev env -->

  <config key="confDir"         value="conf{DevEnv}"/>
  <config key="connDir"         value="conn{DevEnv}"/>

  <!--********************************************************************
 Command Line Args - Region and Overwriting the IRMA ExtraText table
********************************************************************-->
  <config key="Reg"                  value="RM"/>
  <config key="OverwriteIngredients" value="Y"/>

  <!--********************************************************************
 Global Key Definitions
********************************************************************-->
  <config key="sqlTimeout"      value="1800"/>
  <config key="emailSMTPServer" value="smtp.wholefoods.com"/>
  <config key="LogFile"         value="logs/{Reg}_NutrichefNutrifactsToIRMAImport_{yyyy}{mm}{dd}.log"/>
  <config key="NutrifactsLoad"  value="##NutrifactsLoad"/>
  <config key="tempnutrifacts"  value="##{reg}_tempnutrifacts"/>

  <!--********************************************************************
 Database Connections
********************************************************************-->
  <config key="IRMA"            value="FILE:{connDir}/{Reg}_NutriChef_IRMA_Connection.txt"/>
  <config key="NUTRICHEF"       value="FILE:{connDir}/NutriChef_Connection.txt"/>

  <!--********************************************************************
 Delimiter Configurations
********************************************************************-->
  <config key="pipe"           value="|"/>
  <config key="arg-delim"      value="~"/>

  <!--********************************************************************
 Source / Target Entries
********************************************************************-->
  <config key="MaxEntries"      value="2"/>
  <config key="source_1"        value="DB, NUTRICHEF, QUERY, GetNutrifactsFromNutrichef, pipe, , , "/>

  <config key="target_1"        value="DB, IRMA, REPLACE, {NutrifactsLoad}, pipe, maketable, updatetemptable;updatenutrifactstable;updatenutrichefwithtimestamp, "/>

  <!--*****************************************************************   
***
 Email Notifications
********************************************************************-->
  <config key="notify_1"  value="GetNutrifactsEmail_error"/>

  <config key="GetNutrifactsEmail_error"  value="GetNutrifactsEmail_error_msg, {Reg}{DevEnv} import nutrifacts failed, dontreply@wholefoods.com, {emailTo}, "/>

  <config key="GetNutrifactsEmail_error_msg"  value=":( Check log for details. "/>

  <config key="GetNutrifactsEmail_success"  value="GetNutrifactsEmail_success_msg, {Reg}{DevEnv} import nutrifacts passed, dontreply@wholefoods.com, {emailTo}, "/>

  <config key="GetNutrifactsEmail_success_msg"  value=":)"/>

  <!--********************************************************************
 Queries
********************************************************************-->
  <config key="GetNutrifactsFromNutrichef"   value="
SELECT ss.plu,
	NULL AS nutrifactid, -- getting nutrifactid later on
	NULL AS scale_extratext_id, -- getting scale_extratext_id later on
	nf.servingunits,
	nf.size,
	nf.sizeweight,
	nf.calories,
	nf.caloriesfat,
	nf.caloriessaturatedfat,
	nf.PerContainer,
	nf.totalfatweight,
	nf.totalfatpercentage,
	nf.saturatedfatweight,
	nf.saturatedfatpercent,
	nf.polyunsaturatedfat,
	nf.monounsaturatedfat,
	nf.cholesterolweight,
	nf.cholesterolpercent,
	nf.sodiumweight,
	nf.sodiumpercent,
	nf.potassiumweight,
	nf.potassiumpercent,
	nf.totalcarbohydrateweight,
	nf.totalcarbohydratepercent,
	nf.dietaryfiberweight,
	nf.dietaryfiberpercent,
	nf.solublefiber,
	nf.insolublefiber,
	nf.sugar,
	nf.sugaralcohol,
	nf.othercarbohydrates,
	nf.proteinweight,
	nf.proteinpercent,
	nf.vitamina,
	nf.betacarotene,
	nf.vitaminc,
	nf.calcium,
	nf.iron,
	nf.vitamind,
	nf.vitamine,
	nf.thiamin,
	nf.riboflavin,
	nf.niacin,
	nf.vitaminb6,
	nf.folate,
	nf.vitaminb12,
	nf.biotin,
	nf.pantothenicacid,
	nf.phosphorous,
	nf.iodine,
	nf.magnesium,
	nf.zinc,
	nf.copper,
	nf.transfat,
	nf.caloriesfromtransfat,
	nf.om6fatty,
	nf.om3fatty,
	nf.starch,
	nf.chloride,
	nf.chromium,
	nf.vitamink,
	nf.manganese,
	nf.molybdenum,
	nf.selenium,
	nf.SizeText,
	nf.transfatweight,
	(i.ingredients + '  CONTAINS: ' + nf.allergens) AS ingredients,
	nf.nutrichefid
INTO {TempNutrifacts}
FROM nutrifacts nf
JOIN servingsize ss ON ss.nutrichefid = nf.nutrichefid
LEFT JOIN ingredients i ON i.RecipeID = ss.RecipeID
JOIN regprofcent rpc ON rpc.profcentid = ss.profitcenterid
WHERE ss.ReadyToSend = 1
	AND ss.ModifiedByDate {GT} ss.SentToIRMADate
	AND rpc.ProfCentID = {PRFID}
	AND ss.plu {LT}{GT} ''
	AND ss.plu is not null

SELECT *
FROM {TempNutrifacts}	
"/>

  <config key="maketable"     value="DB, IRMA, QUERY, make_table, "/>

  <config key="make_table"    value="
SET NOCOUNT ON;
IF EXISTS (SELECT * FROM tempdb.dbo.sysobjects WHERE Name = '{NutrifactsLoad}') DROP TABLE {NutrifactsLoad};
CREATE TABLE {NutrifactsLoad} (
	[plu] [VARCHAR](50) NULL,
	[nutrifactsid] [INT] NULL,
	[scale_extratext_id] [INT] NULL,
	[servingunits] [TINYINT] NULL,
	[ServingsPerPortion] [INT] NULL,
	[sizeweight] [INT] NULL,
	[calories] [INT] NULL,
	[caloriesfat] [INT] NULL,
	[caloriessaturatedfat] [INT] NULL,
	[ServingPerContainer] [VARCHAR](10) NULL,
	[totalfatweight] [DECIMAL](5, 1) NULL,
	[totalfatpercentage] [SMALLINT] NULL,
	[saturatedfatweight] [DECIMAL](5, 1) NULL,
	[saturatedfatpercent] [SMALLINT] NULL,
	[polyunsaturatedfat] [INT] NULL,
	[monounsaturatedfat] [INT] NULL,
	[cholesterolweight] [DECIMAL](5, 1) NULL,
	[cholesterolpercent] [SMALLINT] NULL,
	[sodiumweight] [DECIMAL](5, 1) NULL,
	[sodiumpercent] [SMALLINT] NULL,
	[potassiumweight] [DECIMAL](5, 1) NULL,
	[potassiumpercent] [SMALLINT] NULL,
	[totalcarbohydrateweight] [DECIMAL](5, 1) NULL,
	[totalcarbohydratepercent] [SMALLINT] NULL,
	[dietaryfiberweight] [DECIMAL](5, 1) NULL,
	[dietaryfiberpercent] [SMALLINT] NULL,
	[solublefiber] [DECIMAL](5, 1) NULL,
	[insolublefiber] [DECIMAL](5, 1) NULL,
	[sugar] [DECIMAL](5, 1) NULL,
	[sugaralcohol] [DECIMAL](5, 1) NULL,
	[othercarbohydrates] [DECIMAL](5, 1) NULL,
	[proteinweight] [DECIMAL](5, 1) NULL,
	[proteinpercent] [SMALLINT] NULL,
	[vitamina] [SMALLINT] NULL,
	[betacarotene] [SMALLINT] NULL,
	[vitaminc] [SMALLINT] NULL,
	[calcium] [SMALLINT] NULL,
	[iron] [SMALLINT] NULL,
	[vitamind] [SMALLINT] NULL,
	[vitamine] [SMALLINT] NULL,
	[thiamin] [SMALLINT] NULL,
	[riboflavin] [SMALLINT] NULL,
	[niacin] [SMALLINT] NULL,
	[vitaminb6] [SMALLINT] NULL,
	[folate] [SMALLINT] NULL,
	[vitaminb12] [SMALLINT] NULL,
	[biotin] [SMALLINT] NULL,
	[pantothenicacid] [SMALLINT] NULL,
	[phosphorous] [SMALLINT] NULL,
	[iodine] [SMALLINT] NULL,
	[magnesium] [SMALLINT] NULL,
	[zinc] [SMALLINT] NULL,
	[copper] [SMALLINT] NULL,
	[transfat] [SMALLINT] NULL,
	[caloriesfromtransfat] [INT] NULL,
	[om6fatty] [DECIMAL](5, 1) NULL,
	[om3fatty] [DECIMAL](5, 1) NULL,
	[starch] [DECIMAL](5, 1) NULL,
	[chloride] [SMALLINT] NULL,
	[chromium] [SMALLINT] NULL,
	[vitamink] [SMALLINT] NULL,
	[manganese] [SMALLINT] NULL,
	[molybdenum] [SMALLINT] NULL,
	[selenium] [SMALLINT] NULL,
	[ServingSizeDesc] [VARCHAR](28) NULL,
	[transfatweight] [DECIMAL](5, 1) NULL,
	[ingredients] [VARCHAR](4200) NULL,
	[nutrichefid] int
	)

CREATE TABLE ##nfidout (
	nutrifactsid INT,
	identifier VARCHAR(28)
	)
"/>

  <config key="updatetemptable"    value="DB, IRMA, QUERY, update_temp_table, "/>

  <config key="update_temp_table"   value="
UPDATE tmp
SET tmp.[nutrifactsid] = s.nutrifact_id
FROM {NutrifactsLoad} tmp
JOIN itemidentifier ii ON ii.identifier = tmp.plu
JOIN itemscale s ON s.item_key = ii.item_key
	AND s.nutrifact_id IS NOT NULL
JOIN item i ON i.item_key = ii.item_key
	AND i.deleted_item = 0
"/>

  <config key="updatenutrifactstable"    value="DB, IRMA, QUERY, update_nutrifacts_table, "/>

  <config key="update_nutrifacts_table"   value="
MERGE INTO NutriFacts trgt
USING {NutrifactsLoad} src
	ON src.nutrifactsid = trgt.nutrifactsid
WHEN MATCHED
	THEN
		UPDATE
		SET servingunits = src.servingunits,
			ServingsPerPortion = src.ServingsPerPortion,
			sizeweight = src.sizeweight,
			calories = src.calories,
			caloriesfat = src.caloriesfat,
			caloriessaturatedfat = src.caloriessaturatedfat,
			ServingPerContainer = src.ServingPerContainer,
			totalfatweight = src.totalfatweight,
			totalfatpercentage = src.totalfatpercentage,
			saturatedfatweight = src.saturatedfatweight,
			saturatedfatpercent = src.saturatedfatpercent,
			polyunsaturatedfat = src.polyunsaturatedfat,
			monounsaturatedfat = src.monounsaturatedfat,
			cholesterolweight = src.cholesterolweight,
			cholesterolpercent = src.cholesterolpercent,
			sodiumweight = src.sodiumweight,
			sodiumpercent = src.sodiumpercent,
			potassiumweight = src.potassiumweight,
			potassiumpercent = src.potassiumpercent,
			totalcarbohydrateweight = src.totalcarbohydrateweight,
			totalcarbohydratepercent = src.totalcarbohydratepercent,
			dietaryfiberweight = src.dietaryfiberweight,
			dietaryfiberpercent = src.dietaryfiberpercent,
			solublefiber = src.solublefiber,
			insolublefiber = src.insolublefiber,
			sugar = src.sugar,
			sugaralcohol = src.sugaralcohol,
			othercarbohydrates = src.othercarbohydrates,
			proteinweight = src.proteinweight,
			proteinpercent = src.proteinpercent,
			vitamina = src.vitamina,
			betacarotene = src.betacarotene,
			vitaminc = src.vitaminc,
			calcium = src.calcium,
			iron = src.iron,
			vitamind = src.vitamind,
			vitamine = src.vitamine,
			thiamin = src.thiamin,
			riboflavin = src.riboflavin,
			niacin = src.niacin,
			vitaminb6 = src.vitaminb6,
			folate = src.folate,
			vitaminb12 = src.vitaminb12,
			biotin = src.biotin,
			pantothenicacid = src.pantothenicacid,
			phosphorous = src.phosphorous,
			iodine = src.iodine,
			magnesium = src.magnesium,
			zinc = src.zinc,
			copper = src.copper,
			transfat = src.transfat,
			caloriesfromtransfat = src.caloriesfromtransfat,
			om6fatty = src.om6fatty,
			om3fatty = src.om3fatty,
			starch = src.starch,
			chloride = src.chloride,
			chromium = src.chromium,
			vitamink = src.vitamink,
			manganese = src.manganese,
			molybdenum = src.molybdenum,
			selenium = src.selenium,
			ServingSizeDesc = src.ServingSizeDesc,
			transfatweight = src.transfatweight
WHEN NOT MATCHED
	THEN
		INSERT (
			Scale_LabelFormat_ID,
			Description,
			servingunits,
			ServingsPerPortion,
			sizeweight,
			calories,
			caloriesfat,
			caloriessaturatedfat,
			ServingPerContainer,
			totalfatweight,
			totalfatpercentage,
			saturatedfatweight,
			saturatedfatpercent,
			polyunsaturatedfat,
			monounsaturatedfat,
			cholesterolweight,
			cholesterolpercent,
			sodiumweight,
			sodiumpercent,
			potassiumweight,
			potassiumpercent,
			totalcarbohydrateweight,
			totalcarbohydratepercent,
			dietaryfiberweight,
			dietaryfiberpercent,
			solublefiber,
			insolublefiber,
			sugar,
			sugaralcohol,
			othercarbohydrates,
			proteinweight,
			proteinpercent,
			vitamina,
			betacarotene,
			vitaminc,
			calcium,
			iron,
			vitamind,
			vitamine,
			thiamin,
			riboflavin,
			niacin,
			vitaminb6,
			folate,
			vitaminb12,
			biotin,
			pantothenicacid,
			phosphorous,
			iodine,
			magnesium,
			zinc,
			copper,
			transfat,
			caloriesfromtransfat,
			om6fatty,
			om3fatty,
			starch,
			chloride,
			chromium,
			vitamink,
			manganese,
			molybdenum,
			selenium,
			ServingSizeDesc,
			transfatweight
			)
		VALUES (
			'1',
			src.plu,
			src.servingunits,
			src.ServingsPerPortion,
			src.sizeweight,
			src.calories,
			src.caloriesfat,
			src.caloriessaturatedfat,
			src.ServingPerContainer,
			src.totalfatweight,
			src.totalfatpercentage,
			src.saturatedfatweight,
			src.saturatedfatpercent,
			src.polyunsaturatedfat,
			src.monounsaturatedfat,
			src.cholesterolweight,
			src.cholesterolpercent,
			src.sodiumweight,
			src.sodiumpercent,
			src.potassiumweight,
			src.potassiumpercent,
			src.totalcarbohydrateweight,
			src.totalcarbohydratepercent,
			src.dietaryfiberweight,
			src.dietaryfiberpercent,
			src.solublefiber,
			src.insolublefiber,
			src.sugar,
			src.sugaralcohol,
			src.othercarbohydrates,
			src.proteinweight,
			src.proteinpercent,
			src.vitamina,
			src.betacarotene,
			src.vitaminc,
			src.calcium,
			src.iron,
			src.vitamind,
			src.vitamine,
			src.thiamin,
			src.riboflavin,
			src.niacin,
			src.vitaminb6,
			src.folate,
			src.vitaminb12,
			src.biotin,
			src.pantothenicacid,
			src.phosphorous,
			src.iodine,
			src.magnesium,
			src.zinc,
			src.copper,
			src.transfat,
			src.caloriesfromtransfat,
			src.om6fatty,
			src.om3fatty,
			src.starch,
			src.chloride,
			src.chromium,
			src.vitamink,
			src.manganese,
			src.molybdenum,
			src.selenium,
			src.ServingSizeDesc,
			src.transfatweight
			)
OUTPUT inserted.nutrifactsid,
	src.plu
INTO ##nfidout(nutrifactsid, identifier);

UPDATE tmp
SET tmp.[nutrifactsid] = nfid.nutrifactsid
FROM {NutrifactsLoad} tmp
JOIN ##nfidout nfid ON tmp.plu = nfid.identifier

UPDATE si
SET si.Nutrifact_ID = nf.nutrifactsid
FROM itemscale si
JOIN itemidentifier ii ON si.Item_Key = ii.Item_Key
JOIN {NutrifactsLoad} nf ON nf.plu = ii.Identifier

IF '{OverwriteIngredients}' = 'Y'
BEGIN
	UPDATE trgt
	SET trgt.extratext = src.ingredients
	FROM Scale_ExtraText trgt
	JOIN {NutrifactsLoad} src ON src.plu = trgt.Description
	WHERE src.ingredients IS NOT NULL
END
"/>

  <config key="updatenutrichefwithtimestamp"    value="DB, NUTRICHEF, QUERY, update_nutrichef_with_timestamp,pipe"/>

  <config key="update_nutrichef_with_timestamp"   value="
UPDATE s
SET s.SentToIrmaDate = GETDATE()
FROM ServingSize s
JOIN {TempNutrifacts} t on s.NutriChefID = t.nutrichefid

"/>

</configuration>