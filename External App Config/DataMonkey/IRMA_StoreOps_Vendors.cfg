<?xml version="1.0" encoding="utf-8" ?>
<!--
**************************************************************************************
   File: IRMA_StoreOps.cfg
 Author: Faisal Ahmed
   Date: 05/12/2008
      
Description: This file contains key settings that drive the transfer of vendor data
             from IRMA to StoreOps

Modification History: 
 Date       Init Comment
 05/12/2008 FA   Created.
 10/22/2009 MY   Modified connection string keys to point to .
**************************************************************************************
-->
<configuration>
   <config key="conTimeout"       value="1800"/>
   <config key="sqlTimeout"       value="1800"/>
   <config key="email"            value="{Storeops_Support_Email}"/>
   <config key="emailSMTPServer"  value="smtp.wholefoods.com"/>
   <config key="LogFile"          value="/logs/{Reg}/datamonkey/StoreOps_Vendors_{yyyy}{MM}{dd}.log"/>
   <config key="ParameterFile"    value="conf_dev/{Reg}_StoreOps_Vendors.prm"/>
   <config key="App"              value="DM - STOREOPS VENDORS JOB"/> 
   <config key="arg-delim"        value="~"/>
   <config key="pipe"      value="|"/>

   <!-- Database Connection string keys -->
   <config key="IRMA_Source"      value="FILE:conn/{Reg}_IRMA_Connection_dev.txt"/>
   <config key="StoreOps_Target"  value="FILE:conn/{Reg}_StoreOps_Connection_dev.txt"/>
   
   
   <config key="arguments_1"     value="DB, IRMA_Source, QUERY, getArgs, arg-delim, , "/>
<!--
*****************************************************************************************************
 Query to get arguments
*****************************************************************************************************
-->
	<config key="getArgs"            value="
	declare @mySQL varchar(MAX);

      SET @mySQL = '
         SELECT
            a.Name          AppName,
            ace.ShortName	Environment,
            ack.Name        KeyName,
            acv.Value       KeyValue
         FROM
            AppConfigApp a

            INNER JOIN AppConfigEnv ace
                  ON (ace.EnvironmentId = a.EnvironmentId)

            INNER JOIN AppConfigValue acv
                  ON (acv.ApplicationId = a.ApplicationId)

            INNER JOIN AppConfigKey ack
                  ON (ack.KeyId = acv.KeyId)

         WHERE
            a.Name like ''{App}''
         AND
			ace.EnvironmentID = ''{Env}''
		 AND
            acv.Deleted = 0
         AND 
            a.Deleted = 0
         AND
            ace.Deleted = 0
         AND 
            ack.Deleted = 0
         ';

      exec dbo.pivot_query @mySQL, 'AppName', 'KeyName', 'max(KeyValue)';
   "/>

	<!-- Database Commands -->
   <config key="fillVendTmp"      value="DB, IRMA_Source, QUERY, fillVendorTemp"/>
   <config key="cleanVendTmp"     value="DB, IRMA_Source, QUERY, cleanVendorTemp"/>
   <config key="cleanVendorQue"   value="DB, IRMA_Source, QUERY, cleanVendorQueue"/>

   <!-- Connections to process -->
   <config key="maxEntries"       value="1"/>
   <config key="source_1"         value="DB, IRMA_Source, PROC, StoreOpsVendorExport, pipe, cleanVendTmp;fillVendTmp, cleanVendorQue;cleanVendTmp"/>

   <config key="target_1"         value="DB, StoreOps_Target, APPEND, VendorIRMALoad"/>

   <config key="fillVendorTemp"   value="insert into tmpVendExport select * from VendorExportQueue where DeliveredToStoreOpsDate is null"/>

   <config key="cleanVendorQueue" value="update VendorExportQueue set DeliveredToStoreOpsDate = getdate() where VendorExportQueueId in (select VendorExportQueueId from tmpVendExport)"/>

   <config key="cleanVendorTemp"  value="truncate table tmpVendExport"/>
 
</configuration>