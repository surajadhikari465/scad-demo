<?xml version="1.0" encoding="utf-8" ?>
<!--
**************************************************************************************
   File: IRMA_Spaceman.cfg
 Author: Ron Savage
   Date: 06/08/2012
      
Description:
This file runs an item information extract used by the NPSS Team Spaceman application.

It uses the following parameters defined on the command line:

conf\IRMA_Spaceman.cfg Y 3 Y Reg=SW Env=(TST|QA|PRD) Server=idd-{Region} dbname=ItemCatalog_Test dbuser=IRMAReports

Modification History:
Date        Init Comment
04/10/2013  KM   Updated for IRMA 4.8 discontinue logic;
06/18/2012  RS   Updated to only send error notifications.
06/11/2012  RS   Updated to use Spaceman folder for data files.
06/08/2012  RS   Updated to run off single config file with regional parameters on Tidal
                 like the other DM jobs.
06/08/2012  RS   Created.
**************************************************************************************
-->
<configuration>
   <config key="App"             value="DM - IRMA Spaceman"/>
   <config key="conTimeout"      value="30"/>
   <config key="sqlTimeout"      value="1800"/>
   <config key="email"           value="WFMNPSSTeam@wholefoods.com"/>
   <config key="emailSMTPServer" value="smtp.wholefoods.com"/>
   <config key="LogFile"         value="/IRMA/logs/{Reg}/{Server}_IRMA_Spaceman_{yyyy}{MM}{dd}.log"/>
  <config key="ParameterFile"    value="conf/{Server}_IRMA_Spaceman.prm"/>

   <!-- Delimiter keys -->
   <config key="pipe_delim"      value="|"/>
   <config key="arg_delim"       value="|"/>

   <!-- Database ODBC Connection string keys -->
   <config key="IRMA"            value="FILE:conn\{Server}_{dbuser}_Connection.txt"/>

   <config key="maxEntries"      value="1"/>
   <config key="source_1"        value="DB, IRMA, QUERY, ItemQuery"/>
   <config key="target_1"        value="File, REPLACE, E:\Data\Spaceman\{Reg}_ITEM_VIM.dat, pipe_delim"/>
   <config key="notify_1"        value="status_error"/>

   <config key="status_error"    value="status_error_msg,{Server} Spaceman failure!, GlobalIRMATechnicalSupport@wholefoods.com, {email}, "/>

   <config key="status_error_msg"  value="Dang.

{LOG_BUFFER}"/>

   <config key="status_success"  value="status_success_msg,{Server} Spaceman success!, GlobalIRMATechnicalSupport@wholefoods.com, {email}, "/>

   <config key="status_success_msg"  value="Yay!

{LOG_BUFFER}"/>


   <config key="ItemQuery"       value="
      SELECT
         i.Item_Key                                                  as ItemKey,
         RIGHT('0000000000000' + ii.Identifier,13)                   As Identifier,
         CASE WHEN ii.National_Identifier = 0 THEN 'N' ELSE 'Y' END  As National_Identifier,
         i.SubTeam_No                                                as SubTeam_No,
         RTRIM(st.SubTeam_Name)                                      as SubTeamName,
         st.Dept_No                                                  As POSDept,
         RTRIM(st.SubTeam_Name)                                      As POSDeptName,
         RTRIM(i.Item_Description)                                   As Item_Description,
         ib.Brand_Name                                               as Brand_Name,
         ipu.Unit_Name                                               As RetailPack_UOM,
         i.Package_Desc2                                             as Item_Size,
         ic.Category_Name                                            As IRMA_CLASS,
         NIC.NatFamilyID                                             AS NAT_FAM,
         NIF.NatFamilyName                                           As NAT_FAM_NAME,
         NICL.NatCatID                                               AS NAT_CAT,
         NIC.NatCatName                                              AS NAT_CAT_NAME,
         NICL.ClassID                                                AS NAT_CLASS,
         NICL.ClassName                                              AS NAT_CLASS_NAME,
         RTRIM(i.Product_Code)                                       As PLANO_CODE,
         ph.ProdHierarchyLevel3_ID                                   As MA_Level3,
         i.ProdHierarchyLevel4_ID                                    As MA_Level4,
         ia.ItemAttribute_ID,
         ia.Item_Key,
         ia.Check_Box_1,
         ia.Check_Box_2,
         ia.Check_Box_3,
         ia.Check_Box_4,
         ia.Check_Box_5,
         ia.Check_Box_6,
         ia.Check_Box_7,
         ia.Check_Box_8,
         ia.Check_Box_9,
         ia.Check_Box_10,
         ia.Check_Box_11,
         ia.Check_Box_12,
         ia.Check_Box_13,
         ia.Check_Box_14,
         ia.Check_Box_15,
         ia.Check_Box_16,
         ia.Check_Box_17,
         ia.Check_Box_18,
         ia.Check_Box_19,
         ia.Check_Box_20,
         ia.Text_1,
         ia.Text_2,
         ia.Text_3,
         ia.Text_4,
         ia.Text_5,
         ia.Text_6,
         ia.Text_7,
         ia.Text_8,
         ia.Text_9,
         ia.Text_10,
         CONVERT(varchar, ia.Date_Time_1, 101)                       As Date_Time_1,
         CONVERT(varchar, ia.Date_Time_2, 101)                       As Date_Time_2,
         CONVERT(varchar, ia.Date_Time_3, 101)                       As Date_Time_3,
         CONVERT(varchar, ia.Date_Time_4, 101)                       As Date_Time_4,
         CONVERT(varchar, ia.Date_Time_5, 101)                       As Date_Time_5,
         CONVERT(varchar, ia.Date_Time_6, 101)                       As Date_Time_6,
         CONVERT(varchar, ia.Date_Time_7, 101)                       As Date_Time_7,
         CONVERT(varchar, ia.Date_Time_8, 101)                       As Date_Time_8,
         CONVERT(varchar, ia.Date_Time_9, 101)                       As Date_Time_9,
         CONVERT(varchar, ia.Date_Time_10, 101)                      As Date_Time_10,
         case when i.Deleted_Item = 0 Then 'N' else 'Y' end          as Deleted_Item,
         case when dbo.fn_GetDiscontinueStatus(i.Item_Key, NULL, NULL) = 0 
	          Then 'N' else 'Y' end											               As Discontinue_Item,
         case when i.Not_Available = 0 Then 'N' else 'Y' end         as Not_Available,
         case when i.WFM_Item = 0 Then 'N' else 'Y' end              as WFM_Item,
         case when i.Remove_Item = 0 Then 'N' else 'Y' end           as Remove_Item,
         case when i.Recall_Flag = 0 Then 'N' else 'Y' end           as Recall_Flag,
         CONVERT(varchar, i.Insert_Date, 101)                        As InsertDate,
         i.Package_Desc1                                             as ItemPack,
         st.Team_No                                                  As TeamNo,
         RTRIM(t.Team_Name)                                          As TeamName
      FROM
         Item i

         JOIN ItemIdentifier ii (NOLOCK)
            ON i.Item_Key = ii.Item_Key

         JOIN ItemBrand  ib (NOLOCK)
            ON ib.Brand_ID = i.Brand_ID

         JOIN SubTeam st (NOLOCK)
            ON st.SubTeam_No = i.SubTeam_No

         JOIN Team t (NOLOCK)
            on t.team_no = st.Team_No

         JOIN ItemUnit ipu (NOLOCK)
            ON ipu.Unit_ID = i.Package_Unit_ID

         JOIN NatItemClass NICL (NOLOCK)
            ON NICL.ClassID = i.ClassID

         JOIN NatItemCat NIC (NOLOCK)
            ON NIC.NatCatID = NICL.NatCatID

         JOIN NatItemFamily NIF (NOLOCK)
            ON NIC.NatFamilyID = NIF.NatFamilyID

         LEFT JOIN ItemAttribute ia (NOLOCK)
            ON ia.Item_Key = i.Item_Key

         LEFT JOIN ProdHierarchyLevel4 ph (NOLOCK)
            ON ph.ProdHierarchyLevel4_ID = i.ProdHierarchyLevel4_ID

         LEFT JOIN ItemCategory ic (NOLOCK)
            ON ic.Category_Id = i.Category_Id
      WHERE
         i.Item_Key > 0

      ORDER BY
         i.Item_Key
   "/>

   <!--*****************************************************************************************************
       Query to get arguments
   *****************************************************************************************************-->
<!--    <config key="arguments_1"     value="DB, IRMA, QUERY, getArgs, arg-delim, , "/> -->
   <config key="getArgs"            value="
      declare @mySQL varchar(MAX);

      SET @mySQL = '
         SELECT
            a.Name          AppName,
            ace.ShortName   Environment,
            ack.Name        KeyName,
            acv.Value       KeyValue
         FROM
            AppConfigApp a

            INNER JOIN AppConfigEnv ace
                  ON (ace.EnvironmentId = a.EnvironmentId)

            INNER JOIN AppConfigValue acv
                  ON (acv.ApplicationId = a.ApplicationId)

            INNER JOIN AppConfigKey ack
                  ON (ack.KeyId = acv.KeyId)

         WHERE
            a.Name like ''{App}''
            AND ace.ShortName = ''{Env}''
            AND acv.Deleted = 0
            AND a.Deleted = 0
            AND ace.Deleted = 0
            AND ack.Deleted = 0
         ';

      exec dbo.pivot_query @mySQL, 'AppName,Environment', 'KeyName', 'max(KeyValue)';
   "/>
</configuration>
