<?xml version="1.0" encoding="utf-8" ?>
<configuration>
<!--****************************************************************
 Config File: IRMAOrdersToChefTec.cfg
      Author: M. Zhao
        Date: 07/26/2011

 Description: 
 This job extracts IRMA POs originated from Store Order Guide and writes
 them to a delimited text file. The file will then be FTPed to the ChefTec 
 server for a ChefTec import job to pick up and load into ChefTec. At the 
 end of the FTP, the extracted IRMA POs' SentDate on the OrderHeader table
 will be updated to the job run date so that the processed IRMA POs will NOT
 be sent over to ChefTec again.

 Modification History: 
 Date       Init Comment
 08/11/2011 DM   Created.
******************************************************************-->

<!--********************************************************************
 Global Key Definitions
********************************************************************-->

   <config key="sqlTimeout"      value="1800"/>
   <config key="emailSMTPServer" value="smtp.wholefoods.com"/>
   <config key="LogFile"         value="/IRMA/logs/{Reg}/IRMA_To_ChefTec_Export_{yyyy}{MM}{dd}.log"/>
   <config key="ParameterFile"   value="conf_dev/{Reg}_IRMAOrdersToChefTec.prm"/>
   <config key="MaxEntries"      value="1"/>

   <!-- Database Connection string keys -->
   <config key="IRMA"            value="FILE:conn/{Reg}_IRMA_Connection.txt"/>
   
   <config key="ftpServer"       value="cewd7530"/>
   <config key="ftpUser"         value="ftp_user"/>
   <config key="ftpPassword"     value="cewd7530FTP"/>
   <config key="ftpDir"          value="{Reg}"/>
   <config key="archiveDir"      value="E:\Data\IRMAOrdersToChefTec\{Reg}\backup"/>
   
   <config key="App"             value="DM - IRMA ORDERS TO ChefTec"/>
   <config key="VendorId"        value="{VendorId}"/>
   
<!--********************************************************************
 FTP Connections
********************************************************************-->
   <config key="ftp_ftp"  value="FTP, {ftpServer}, {ftpUser}, {ftpPassword}, ASC, , REPLACE, {ftpDir}, POs_For_ChefTec.dat, , "/>

<!--********************************************************************
 Delimiter Configurations
********************************************************************-->
   <config key="pipe"           value="|"/>
   <config key="arg-delim"      value="~"/>

<!--********************************************************************
 Source / Target Entries
********************************************************************-->
   <config key="source_1"  value="DB, IRMA, QUERY, RetrieveIRMAOrders, pipe, , "/>
   <config key="target_1" value="FILE, REPLACE, {archiveDir}\POs_For_ChefTec.{yy}{MM}{dd}{HH}{MI}, pipe, , UpdIRMAOrders, ftp_ftp, , "/>
   
   <!--<config key="notify_1" value="notify_failure_1, notify_success_1"/>-->

   <config key="notify_1" value="notify_failure_1, "/>
   <config key="notify_failure_1" value="notify_failure_msg, IRMA Order Export to ChefTec FAILED, {emailFrom}, {emailTo}, "/>
   <config key="notify_success_1" value="notify_success_msg, IRMA Order Export to ChefTec SUCCESS, {emailFrom}, {emailTo}, "/>

   
   <config key="notify_success_msg" value="file:conf/IRMAOrdersToChefTec_Success.html"/>
   <config key="notify_failure_msg" value="file:conf/IRMAOrdersToChefTec_Failure.html"/>
   
   <config key="arguments_1"     value="DB, IRMA, QUERY, getArgs, arg-delim, , "/>
   
   <config key="UpdIRMAOrders"     value="DB, IRMA, QUERY, UpdIRMAPOs"/>
   
   <config key="UpdIRMAPOs"  value=" 	   
           UPDATE OrderHeader 
                  SET SentDate = GETDATE() 
           WHERE OrderHeader_ID IN
				(SELECT distinct (oh.OrderHeader_ID)
				   FROM Orderheader (NOLOCK) oh
			     INNER JOIN OrderItem (NOLOCK) oi
				    ON oh.OrderHeader_ID = oi.OrderHeader_ID
					   INNER JOIN vendor (NOLOCK) v
				    ON v.Vendor_ID = oh.PurchaseLocation_ID
			           INNER JOIN Item (NOLOCK) i
				    ON i.Item_Key = oi.Item_Key
			           INNER JOIN ItemIdentifier (NOLOCK) ii
				    ON i.Item_Key = ii.Item_Key AND Default_Identifier = 1
			           INNER JOIN ItemUnit (NOLOCK) cu
				    ON cu.Unit_ID = CostUnit
			           INNER JOIN SubTeam s
				    ON s.Subteam_No = Transfer_To_SubTeam
		         WHERE oh.Vendor_ID in ({VendorId}) 
			       AND oh.CloseDate IS NULL
				   AND oh.Return_Order = 0
			       AND ISNULL(oh.Sent,0) = 1
			       AND CONVERT(varchar(10),oh.Expected_Date,101) = CONVERT(varchar(10),DateAdd(d,{LeadTimeInDays},GETDATE()),101) 
			       AND oh.OrderDate = oh.SentDate  -- only include orders that haven't been sent to ChefTec yet
			       {OptionalConditions});

           "/>
     
 <!--*********************************************************************
 Query to get arguments
***********************************************************************-->

	<config key="getArgs"            value="
	declare @mySQL varchar(MAX);

      SET @mySQL = '
         SELECT
            a.Name          AppName,
            ace.ShortName	Environment,
            ack.Name        KeyName,
            acv.Value       KeyValue
         FROM
            AppConfigApp a

            INNER JOIN AppConfigEnv ace
                  ON (ace.EnvironmentId = a.EnvironmentId)

            INNER JOIN AppConfigValue acv
                  ON (acv.ApplicationId = a.ApplicationId)

            INNER JOIN AppConfigKey ack
                  ON (ack.KeyId = acv.KeyId)

         WHERE
            a.Name like ''{App}''
         AND
			ace.EnvironmentID = ''{Env}''
		 AND
            acv.Deleted = 0
         AND 
            a.Deleted = 0
         AND
            ace.Deleted = 0
         AND 
            ack.Deleted = 0
         ';

      exec dbo.pivot_query @mySQL, 'AppName', 'KeyName', 'max(KeyValue)';
   "/>

   <config key="RetrieveIRMAOrders"  value="
		SELECT LTRIM(RTRIM(ISNULL(st.StoreAbbr,''))) AS PurchasingStore
			, LTRIM(RTRIM(ISNULL(SubTeam_Name,'')))
			, CONVERT(VARCHAR(10),Expected_Date,101) as OrderExpectedDate
			, Identifier
			, LTRIM(RTRIM(ISNULL(Item_Description,'')))
			, Cost
			, oi.Package_Desc1
			, CASE 
				WHEN  cu.Unit_Abbreviation IN ('LB','BOX') THEN 'LB'
				ELSE 'EA'
				END  as CostUnit
			, QuantityOrdered * oi.Package_Desc1 AS TotalUnits,
			oh.OrderHeader_ID
		FROM Orderheader (NOLOCK) oh
			INNER JOIN OrderItem (NOLOCK) oi
				ON oh.OrderHeader_ID = oi.OrderHeader_ID
			INNER JOIN vendor (NOLOCK) v
				ON v.Vendor_ID = oh.PurchaseLocation_ID
			INNER JOIN Item (NOLOCK) i
				ON i.Item_Key = oi.Item_Key
			INNER JOIN ItemIdentifier (NOLOCK) ii
				ON i.Item_Key = ii.Item_Key AND Default_Identifier = 1
			INNER JOIN ItemUnit (NOLOCK) cu
				ON cu.Unit_ID = CostUnit
			INNER JOIN SubTeam s
				ON s.Subteam_No = Transfer_To_SubTeam
			LEFT OUTER JOIN Store st
				ON v.Store_no = st.Store_No
		WHERE oh.Vendor_ID in ({VendorId}) 
			AND oh.CloseDate IS NULL
			AND oh.Return_Order = 0
			AND ISNULL(oh.Sent,0) = 1
			AND CONVERT(varchar(10),oh.Expected_Date,101) = CONVERT(varchar(10),DateAdd(d,{LeadTimeInDays},GETDATE()),101) 
			AND oh.OrderDate = oh.SentDate  -- only include orders that haven't been sent to ChefTec yet
			{OptionalConditions}
		ORDER BY oh.OrderHeader_ID
	"/>	
	 
</configuration>

