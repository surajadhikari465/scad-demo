<#@ template language="C#" debug="true" hostSpecific="true" #>
<#@ output extension=".cs" #>
<#@ Assembly Name="System.Data" #>
<#@ import namespace="System.Collections.Generic" #>
<#@ import namespace="System.Data" #>
<#@ import namespace="System.Data.SqlClient" #>
<#@ import namespace="System.IO" #>
<#@ import namespace="System.Text.RegularExpressions" #>
<#@ include file="ConfigurationAccessor.ttinclude" #>
<#
    string tableName = "dbo.Trait";
    string path = Path.GetDirectoryName(Host.TemplateFile);
	string codeColumn = "traitCode";
    string descColumn = "traitDesc";
	string idColumn = "traitID";
#>
using System;
using System.CodeDom.Compiler;
using System.Collections.Generic;

namespace Icon.Framework
{
    /// <summary>
    /// <#= tableName #> auto generated Ids
    /// </summary>

    [GeneratedCode("TextTemplatingFileGenerator", "10")]
    public static class Traits
    {
<#
	var codes = new List<string>();
	var descriptions = new List<string>();
	var ids = new List<int>();

    string fullPath = Host.ResolvePath("") + @"App.config";
	var config = new ConfigurationAccessor((IServiceProvider)this.Host, fullPath);
    string connectionString = config.ConnectionStrings["T4"].ConnectionString;
    SqlConnection conn = new SqlConnection(connectionString);
    string command = string.Format("select {0}, {1}, {2} from {3} order by {0}", idColumn, descColumn, codeColumn, tableName);
    SqlCommand comm = new SqlCommand(command, conn);

    conn.Open();

    SqlDataReader reader = comm.ExecuteReader();
    bool loop = reader.Read();

    while(loop)
	{	
		codes.Add(reader[codeColumn].ToString());
		descriptions.Add(reader[descColumn].ToString());
		ids.Add(int.Parse(reader[idColumn].ToString()));

		loop = reader.Read();
	}

	for(int i = 0; i < descriptions.Count;i++)
    {
#>
        public const int <#= Pascalize(descriptions[i]) #> = <#= ids[i] #>;
<#
    }
#>

		private static Dictionary<string, int> codesToIdDictionary = new Dictionary<string, int>
			{
<#
	for(int i = 0; i < ids.Count;i++)
    {
#>
				{ "<#= codes[i] #>", <#= ids[i] #> }<#= i < ids.Count - 1 ? "," : "" #>
<#
	}
#>			};
		public static Dictionary<string, int> Ids { get { return codesToIdDictionary; } }

		public static class Descriptions
		{
<#
	for(int i = 0; i < descriptions.Count;i++)
    {
#>
			public const string <#= Pascalize(descriptions[i]) #> = "<#= descriptions[i] #>";
<#
    }
#>
			
			private static Dictionary<int, string> idToDescriptionsDictionary = new Dictionary<int, string>
			{
<#
	for(int i = 0; i < descriptions.Count;i++)
    {
#>
				{ <#= ids[i] #>, "<#= descriptions[i] #>" }<#= i < descriptions.Count - 1 ? "," : "" #>
<#
	}
#>			};
			public static Dictionary<int, string> AsDictionary { get { return idToDescriptionsDictionary; } }
		}

		public static class Codes
		{
<#
	for(int i = 0; i < codes.Count;i++)
    {
#>
			public const string <#= Pascalize(descriptions[i]) #> = "<#= codes[i] #>";
<#
    }
#>
			
			private static Dictionary<int, string> idToCodesDictionary = new Dictionary<int, string>
			{
<#
	for(int i = 0; i < codes.Count;i++)
    {
#>
				{ <#= ids[i] #>, "<#= codes[i] #>" }<#= i < codes.Count - 1 ? "," : "" #>
<#
	}
#>			};
			public static Dictionary<int, string> AsDictionary { get { return idToCodesDictionary; } }
		}
	}
}
<#+
    private string Pascalize(object value)
    {
        Regex rx = new Regex(@"(?:[^a-zA-Z0-9]*)(?<first>[a-zA-Z0-9])(?<reminder>[a-zA-Z0-9]*)(?:[^a-zA-Z0-9]*)");
        return rx.Replace(value.ToString(), m => m.Groups["first"].ToString().ToUpper() + m.Groups["reminder"].ToString().ToLower());
    }
#>