@using WebSupport.Helpers
@using WebSupport.Models
@using System.Data

@model WebSupport.ViewModels.EventReQueueViewModel
@{ ViewBag.Title = "ReQueue Events"; }

<h2>Requeue InStock Events</h2>
<br />

@using (Html.BeginForm("Index", "ReQueueEvent", null, FormMethod.Post, new { @class = "" }))
{
<table class="table-borderless">
    <tr>
        <td class="col-sm-offset-0 col-sm-1" style="font-size:small; color:gray" align="left">
            @Html.LabelFor(x => x.RegionIndex, new { @class = "control-label" })

            @Html.DropDownListFor(x => x.RegionIndex, Model.OptionsForRegion, new { @class = "form-control", id = "Region", onchange = "HideElement()" })
            @Html.ValidationMessageFor(x => x.RegionIndex, "", new { @class = "text-danger" })
        </td>

        <td class="col-sm-offset-0 col-sm-3" style="font-size:small; color:gray" align="left">&nbsp;</td>
    </tr>
    <tr>
        <td class="col-sm-offset-0 col-sm-1" style="font-size:small; color:gray; width:90px;" align="left">
            @Html.LabelFor(x => x.QueueIndex, new { @class = "control-label" })

            @Html.DropDownListFor(x => x.QueueIndex, Model.Queues, new { @class = "form-control", id = "Queue", onchange = "HideElement()" })
            @Html.ValidationMessageFor(x => x.QueueIndex, "", new { @class = "text-danger" })
        </td>

        <td class="col-sm-offset-0 col-sm-1" style="font-size:small; color:gray;" align="left">
            @Html.LabelFor(x => x.MessageTypeIndex, new { @class = "control-label" })<br />

            @Html.DropDownListFor(x => x.MessageTypeIndex, Model.MessageTypes, new { @class = "form-control", id = "messageType", onchange = "HideElement()" })
        </td>

        <td class="col-sm-offset-0 col-sm-1" style="font-size:small; color:gray;" align="left">
            @Html.LabelFor(x => x.EventType, new { @class = "control-label" })<br />

            @Html.DropDownListFor(x => x.EventType, Model.EventTypes, new { @class = "form-control", id = "eventType", onchange = "HideElement()" })
        </td>
        <td class="col-sm-offset-0 col-sm-1" style="font-size:small; color:gray;" align="left">
            @Html.LabelFor(x => x.StatusIndex, new { @class = "control-label" })<br />

            @Html.DropDownListFor(x => x.StatusIndex, Model.Status, new { @class = "form-control", id = "status", onchange = "HideElement()" })
        </td>
    </tr>
    <tr>
        <td class="col-sm-offset-0 col-sm-1" style="font-size:small; color:gray" align="left">
            @Html.LabelFor(x => x.KeyID, new { @class = "control-label" })<br />

            @Html.TextBoxFor(model => Model.KeyID, new { @class = "form-control" })
            @Html.ValidationMessageFor(model => model.KeyID, "", new { @class = "text-danger" })
        </td>

        <td class="col-sm-offset-0 col-sm-1" style="font-size:small; color:gray" align="left">
            @Html.LabelFor(x => x.SecondaryKeyID, new { @class = "control-label" })<br />

            @Html.TextBoxFor(model => Model.SecondaryKeyID, new { @class = "form-control" })
            @Html.ValidationMessageFor(model => model.SecondaryKeyID, "", new { @class = "text-danger" })
        </td>

        <td class="col-sm-3" style="font-size:small; color:gray; width:80px;" align="left">
            @Html.LabelFor(x => x.StartDatetime, new { @class = "control-label" })
            <div class="input-group date" id="dtpStartDatetime" style="width:180px" align="left">
                @Html.TextBoxFor(model => Model.StartDatetime, new { @class = "form-control" })
                <span class="input-group-addon"> <span class="glyphicon glyphicon-calendar"></span> </span>
            </div>

            <script type="text/javascript">
                $(function () {
                    $('#dtpStartDatetime').datetimepicker({
                        format: 'MM/DD/YYYY HH:mm:ss',
                        sideBySide: true
                    });
                });
            </script>
        </td>

        <td class="col-sm-3" style="font-size:small; color:gray; width:80px;" align="left">
            @Html.LabelFor(x => x.EndDatetime, new { @class = "control-label" })

            <div class="input-group date" id="dtpEndDatetime" style="width:180px">
                @Html.TextBoxFor(model => Model.EndDatetime, new { @class = "form-control" })
                <span class="input-group-addon"> <span class="glyphicon glyphicon-calendar"></span> </span>
            </div>

            <script type="text/javascript">
                $(function () {
                    $('#dtpEndDatetime').datetimepicker({
                        format: 'MM/DD/YYYY HH:mm:ss',
                        sideBySide: true
                    });
                });
            </script>
        </td>
    </tr>
    <tr>
        <td class="col-sm-offset-0 col-sm-2" style="font-size:small; color:gray" align="left">
            <span>
                <br/>
                <input type="submit" value="Search" class="btn btn-primary form-submit" name="btnRefresh" id="btnSearch" />
            </span>
        </td>
        <td class="col-sm-2" style="width:auto" colspan="2" align="left">
            &nbsp;
        </td>
    </tr>
</table>
    <br />
    <br />
    <hr />
    <div id="divView" class="col-sm-12" style="overflow-x:auto">
        @{if (!Model.IsSuccess)
            {
                <div style="background-color:lightyellow; border:2px solid; padding:15px">
                    <h2 style="text-align:center; color:darkred">Processing error</h2>
                    <p>@Model.Error</p>
                    <hr />
                    <p style="font-style:italic; font-weight:600">Please contact your System Administrator if the issue persist.</p>
                </div>
            }
            else
            {
                if (Model.ResultTable != null && Model.ResultTable.Rows.Count == 0)
                {
                    <p style="color:lightgray; text-align:center; font-size:xx-large">No records found...</p>
                }
            }
        }

        @{if (Model.IsSuccess && Model.ResultTable != null && Model.ResultTable.Rows.Count > 0)
            {
                if (Model.ResultTable.Rows.Count > int.Parse(System.Configuration.ConfigurationManager.AppSettings["MaxEntriesForInStockReq"]))
                {
                    <div style="background-color:lightyellow; border:1px solid; padding:2px">
                        <p style="font-style:italic; font-weight:600">Search result returns more than @System.Configuration.ConfigurationManager.AppSettings["MaxEntriesForInStockReq"] rows. Please refine your search criteria.</p>
                    </div>
                    <br />
                }
                else
                {
                    <div style="background-color:lightyellow; border:1px solid; padding:2px">
                        @if (Model.RequeueSuccess ?? false)
                        {
                            <p style="font-style:italic; font-weight:600">Records requeued successfully.</p>
                        }
                        else
                        {
                            <p style="font-style:italic; font-weight:600">@Model.ResultTable.Rows.Count rows returned.</p>
                        }
                    </div>
                    <br />
                    <div class="form-group col-sm-offset-2">
                        <input type="button" value="Select All" class="btn btn-primary form-submit col-md-offset-0" id="btnSelect" name="btnSelectAll" style="background-color:#4CAF50" />
                        <input type="submit" value="Requeue" class="btn btn-primary form-submit col-md-offset-0" id="cmdSend" name="btnSend" style="background-color:#4CAF50" />
                    </div>
                    <br />

                    <table>
                        <tr>
                            <th style="align-items:center; height:30px; width:40px; background:rgb(220, 218, 218)" />

                            @foreach (DataColumn column in Model.ResultTable.Columns)
                            {
                                <th style="text-align:left; padding:8px; height:30px; background:rgb(220, 218, 218)">@column.Caption.Replace("_", " ")</th>
                            }
                        </tr>

                        @foreach (DataRow row in Model.ResultTable.Rows)
                        {
                            <tr>
                                <td align="left" style="padding-left:8px; padding-right: 8px;">
                                    <input type="checkbox" name="cbIsSelected" id="cbIsSelected" value="@row["ArchiveID"]" onclick="" />
                                </td>

                                @foreach (var val in row.ItemArray)
                                {
                                    if (val.GetType() != typeof(String))
                                    {
                                        <td align="right" style="padding-right:15px; padding-right:15px;">@val</td>
                                    }
                                    else
                                    {
                                        <td align="left" style="padding-right:15px; padding-right:15px;">@val</td>
                                    }
                                }
                            </tr>
                        }
                    </table>
                }
            }
        }
    </div>
}


@section Scripts
{
    <script type="text/javascript">
        $(document).on('change', '#Region,#Queue', function () {
            var e = document.getElementById("divView");
            if (e != null) e.style.display = "none";
        });

        $("#btnSelect").click(function () {
            var btnSelectControl = document.getElementById("btnSelect");
            var chk = $('[id^=cbIsSelected]');

            if (btnSelectControl.value == "Select All") {
                for (i = 0; i < chk.length; i++)
                    chk[i].checked = true;
                btnSelectControl.value = "Deselect All";
            } else {
                for (i = 0; i < chk.length; i++)
                    chk[i].checked = false;
                btnSelectControl.value = "Select All";
            }
        });


        function HideElement() {
            return;
        }
    </script>
}
