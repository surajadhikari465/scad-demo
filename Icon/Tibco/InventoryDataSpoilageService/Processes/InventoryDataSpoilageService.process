<?xml version="1.0" encoding="UTF-8"?>
<pd:ProcessDefinition xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:pfx="http://schemas.wfm.com/Enterprise/InventoryMgmt/InventoryAdjustment/V1" xmlns:pd="http://xmlns.tibco.com/bw/process/2003" xmlns:ns="http://www.tibco.com/pe/DeployedVarsType" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:ns0="http://schemas.wfm.com/Enterprise/InventoryMgmt/CommonRefTypes/V1" xmlns:ns1="http://www.tibco.com/namespaces/tnt/plugins/jms">
    <xsd:import namespace="http://schemas.wfm.com/Enterprise/InventoryMgmt/InventoryAdjustment/V1" schemaLocation="/SharedResources/Schemas/WholeFoodsMarket/Inventory/InventoryAdjustment.xsd"/>
    <pd:name>Processes/InventoryDataSpoilageService.process</pd:name>
    <pd:startName>Timer</pd:startName>
    <pd:startX>0</pd:startX>
    <pd:startY>0</pd:startY>
    <pd:returnBindings/>
    <pd:starter name="Timer">
        <pd:type>com.tibco.plugin.timer.TimerEventSource</pd:type>
        <pd:resourceType>ae.activities.timer</pd:resourceType>
        <pd:x>131</pd:x>
        <pd:y>241</pd:y>
        <config>
            <StartTime>1538028264000</StartTime>
            <Frequency>false</Frequency>
            <TimeInterval>%%Application/PublisherTimerInMilliseconds%%</TimeInterval>
            <FrequencyIndex>Millisecond</FrequencyIndex>
        </config>
        <pd:inputBindings/>
    </pd:starter>
    <pd:endName>End</pd:endName>
    <pd:endX>1240</pd:endX>
    <pd:endY>239</pd:endY>
    <pd:errorSchemas/>
    <pd:processVariables/>
    <pd:targetNamespace>http://xmlns.example.com/1538071349052</pd:targetNamespace>
    <pd:group name="BatchAndSendShrinkData">
        <pd:type>com.tibco.pe.core.LoopGroup</pd:type>
        <pd:resourceType>ae.process.group</pd:resourceType>
        <pd:x>417</pd:x>
        <pd:y>78</pd:y>
        <pd:width>671</pd:width>
        <pd:height>308</pd:height>
        <pd:collapsedWidth>57</pd:collapsedWidth>
        <pd:collapsedHeight>70</pd:collapsedHeight>
        <pd:groupVariables/>
        <pd:joinToggle>inherit</pd:joinToggle>
        <config>
            <pd:groupType>inputLoop</pd:groupType>
            <pd:serializable>false</pd:serializable>
            <pd:over>$GetShrinkData/resultSet/Record</pd:over>
            <pd:iterationElementSlot>Records</pd:iterationElementSlot>
            <pd:indexSlot>i</pd:indexSlot>
            <pd:outSlot>Individual_Record</pd:outSlot>
            <pd:activityOutputName>ShrinkDataMapper</pd:activityOutputName>
            <pd:accumulateOutput>true</pd:accumulateOutput>
        </config>
        <pd:inputBindings/>
        <pd:expanded>true</pd:expanded>
        <pd:transition>
            <pd:from>start</pd:from>
            <pd:to>ShrinkDataMapper</pd:to>
            <pd:lineType>Default</pd:lineType>
            <pd:lineColor>-16777216</pd:lineColor>
            <pd:conditionType>always</pd:conditionType>
        </pd:transition>
        <pd:transition>
            <pd:from>ArchiveInventorySpoilageMessage</pd:from>
            <pd:to>end</pd:to>
            <pd:lineType>Default</pd:lineType>
            <pd:lineColor>-16777216</pd:lineColor>
            <pd:conditionType>always</pd:conditionType>
        </pd:transition>
        <pd:transition>
            <pd:from>ShrinkDataMapper</pd:from>
            <pd:to>SendDataToESB</pd:to>
            <pd:lineType>Default</pd:lineType>
            <pd:lineColor>-16777216</pd:lineColor>
            <pd:conditionType>always</pd:conditionType>
        </pd:transition>
        <pd:transition>
            <pd:from>SendDataToESB</pd:from>
            <pd:to>ArchiveInventorySpoilageMessage</pd:to>
            <pd:lineType>Default</pd:lineType>
            <pd:lineColor>-16777216</pd:lineColor>
            <pd:conditionType>always</pd:conditionType>
        </pd:transition>
        <pd:activity name="ShrinkDataMapper">
            <pd:type>com.tibco.plugin.mapper.MapperActivity</pd:type>
            <pd:resourceType>ae.activities.MapperActivity</pd:resourceType>
            <pd:x>553</pd:x>
            <pd:y>145</pd:y>
            <config>
                <element>
                    <xsd:element name="DbData">
                        <xsd:complexType>
                            <xsd:sequence>
                                <xsd:element name="AdjustmentNumber" type="xsd:int"/>
                                <xsd:element name="EventType" type="xsd:int"/>
                                <xsd:element name="TransactionId" type="xsd:string"/>
                                <xsd:element name="LocationNumber" type="xsd:int"/>
                                <xsd:element name="LocationName" type="xsd:string"/>
                                <xsd:element name="SubTeamNumber" type="xsd:int"/>
                                <xsd:element name="SubTeamName" type="xsd:string"/>
                                <xsd:element name="HostSubTeamNumber" type="xsd:int"/>
                                <xsd:element name="HostSubTeamName" type="xsd:string"/>
                                <xsd:element name="CurrentDateTime" type="xsd:time"/>
                            </xsd:sequence>
                        </xsd:complexType>
                    </xsd:element>
                </element>
            </config>
            <pd:inputBindings>
                <DbData>
                    <AdjustmentNumber>
                        <xsl:value-of select="$Records/Record/AdjustmentNumber"/>
                    </AdjustmentNumber>
                    <EventType>
                        <xsl:value-of select="$Records/Record/EventType"/>
                    </EventType>
                    <TransactionId>
                        <xsl:value-of select="$Records/Record/TransactionId"/>
                    </TransactionId>
                    <LocationNumber>
                        <xsl:value-of select="$Records/Record/LocationNumber"/>
                    </LocationNumber>
                    <LocationName>
                        <xsl:value-of select="$Records/Record/LocationName"/>
                    </LocationName>
                    <SubTeamNumber>
                        <xsl:value-of select="$Records/Record/SubTeamNumber"/>
                    </SubTeamNumber>
                    <SubTeamName>
                        <xsl:value-of select="$Records/Record/SubTeamName"/>
                    </SubTeamName>
                    <HostSubTeamNumber>
                        <xsl:value-of select="$Records/Record/HostSubTeamNumber"/>
                    </HostSubTeamNumber>
                    <HostSubTeamName>
                        <xsl:value-of select="$Records/Record/HostSubTeamName"/>
                    </HostSubTeamName>
                    <CurrentDateTime>
                        <xsl:value-of select="$Records/Record/CurrentDateTime"/>
                    </CurrentDateTime>
                </DbData>
            </pd:inputBindings>
        </pd:activity>
        <pd:activity name="SendDataToESB">
            <pd:type>com.tibco.plugin.jms.JMSTopicPublishActivity</pd:type>
            <pd:resourceType>ae.activities.JMSTopicPublishActivity</pd:resourceType>
            <pd:x>738</pd:x>
            <pd:y>148</pd:y>
            <config>
                <PermittedMessageType>XML Text</PermittedMessageType>
                <SessionAttributes>
                    <transacted>false</transacted>
                    <acknowledgeMode>1</acknowledgeMode>
                    <maxSessions>1</maxSessions>
                    <destination>%%Destinations/InventoryManagementTopic%%</destination>
                </SessionAttributes>
                <ConfigurableHeaders>
                    <JMSDeliveryMode>PERSISTENT</JMSDeliveryMode>
                    <JMSExpiration>0</JMSExpiration>
                    <JMSPriority>4</JMSPriority>
                </ConfigurableHeaders>
                <ConnectionReference>/SharedResources/Connections/ESB.sharedjmscon</ConnectionReference>
                <ApplicationProperties>/SharedResources/Properties/JMS-Application-Properties-InventoryManagement.sharedjmsapp</ApplicationProperties>
                <InDataxsdString ref="pfx:inventoryAdjustments"/>
            </config>
            <pd:inputBindings>
                <ns1:ActivityInput>
                    <OtherProperties>
                        <TransactionID>
                            <xsl:value-of select="$ShrinkDataMapper/DbData/TransactionId"/>
                        </TransactionID>
                        <TransactionType>
                            <xsl:value-of select="$_globalVariables/ns:GlobalVariables/Application/TransactionType"/>
                        </TransactionType>
                        <Source>
                            <xsl:value-of select="$_globalVariables/ns:GlobalVariables/Application/InventoryAdjustmentSource"/>
                        </Source>
                        <MessageType>
                            <xsl:value-of select="$_globalVariables/ns:GlobalVariables/Application/MessageType"/>
                        </MessageType>
                    </OtherProperties>
                    <Body>
                        <pfx:inventoryAdjustments>
                            <pfx:inventoryAdjustment>
                                <pfx:adjustmentNumber>
                                    <xsl:value-of select="$ShrinkDataMapper/DbData/AdjustmentNumber"/>
                                </pfx:adjustmentNumber>
                                <pfx:eventType>
                                    <xsl:value-of select="$ShrinkDataMapper/DbData/EventType"/>
                                </pfx:eventType>
                                <pfx:messageNumber>
                                    <xsl:value-of select="$ShrinkDataMapper/DbData/TransactionId"/>
                                </pfx:messageNumber>
                                <pfx:locationNumber>
                                    <xsl:value-of select="$ShrinkDataMapper/DbData/LocationNumber"/>
                                </pfx:locationNumber>
                                <pfx:locationName>
                                    <xsl:value-of select="$ShrinkDataMapper/DbData/LocationName"/>
                                </pfx:locationName>
                                <pfx:invAdjustmentSource>
                                    <xsl:value-of select="$_globalVariables/ns:GlobalVariables/Application/InventoryAdjustmentSource"/>
                                </pfx:invAdjustmentSource>
                                <pfx:inventoryAdjustmentDetail>
                                    <pfx:adjustmentDetailNumber>
                                        <xsl:value-of select="$ShrinkDataMapper/DbData/AdjustmentNumber"/>
                                    </pfx:adjustmentDetailNumber>
                                    <pfx:SubTeam>
                                        <ns0:subTeamNumber>
                                            <xsl:value-of select="$ShrinkDataMapper/DbData/SubTeamNumber"/>
                                        </ns0:subTeamNumber>
                                        <ns0:subTeamName>
                                            <xsl:value-of select="$ShrinkDataMapper/DbData/SubTeamName"/>
                                        </ns0:subTeamName>
                                        <ns0:hostSubTeamNumber>
                                            <xsl:value-of select="$ShrinkDataMapper/DbData/HostSubTeamNumber"/>
                                        </ns0:hostSubTeamNumber>
                                        <ns0:hostSubTeamName>
                                            <xsl:value-of select="$ShrinkDataMapper/DbData/HostSubTeamName"/>
                                        </ns0:hostSubTeamName>
                                    </pfx:SubTeam>
                                    <pfx:inventoryStatus/>
                                    <pfx:createDateTime>
                                        <xsl:value-of select="$ShrinkDataMapper/DbData/CurrentDateTime"/>
                                    </pfx:createDateTime>
                                </pfx:inventoryAdjustmentDetail>
                            </pfx:inventoryAdjustment>
                        </pfx:inventoryAdjustments>
                    </Body>
                </ns1:ActivityInput>
            </pd:inputBindings>
        </pd:activity>
        <pd:activity name="ArchiveInventorySpoilageMessage">
            <pd:type>com.tibco.pe.core.CallProcessActivity</pd:type>
            <pd:resourceType>ae.process.subprocess</pd:resourceType>
            <pd:x>925</pd:x>
            <pd:y>155</pd:y>
            <config>
                <processName>/SharedResources/Processes/ArchiveInventoryManagementMessage.process</processName>
                <spawn>true</spawn>
            </config>
            <pd:inputBindings>
                <Input>
                    <MessageBody>
                        <xsl:value-of select="$Records/Record"/>
                    </MessageBody>
                    <EventType>
                        <xsl:value-of select="$Records/Record/EventType"/>
                    </EventType>
                    <KeyID>
                        <xsl:value-of select="$Records/Record/AdjustmentNumber"/>
                    </KeyID>
                    <SecondaryKeyID>
                        <xsl:value-of select="$_globalVariables/ns:GlobalVariables/Application/SecondaryKeyId"/>
                    </SecondaryKeyID>
                    <Status>
                        <xsl:value-of select="$_globalVariables/ns:GlobalVariables/Application/Status"/>
                    </Status>
                    <ErrorDescription>
                        <xsl:value-of select="$_globalVariables/ns:GlobalVariables/Application/ErrorDescriptionDefault"/>
                    </ErrorDescription>
                    <LastProcessedTime>
                        <xsl:value-of select="$Records/Record/CurrentDateTime"/>
                    </LastProcessedTime>
                    <MessageNumber>
                        <xsl:value-of select="$Records/Record/TransactionId"/>
                    </MessageNumber>
                    <LastReprocess>
                        <xsl:value-of select="$Records/Record/CurrentDateTime"/>
                    </LastReprocess>
                    <LastReprocessID>
                        <xsl:value-of select="$_globalVariables/ns:GlobalVariables/Application/LastReProcessId"/>
                    </LastReprocessID>
                </Input>
            </pd:inputBindings>
        </pd:activity>
    </pd:group>
    <pd:activity name="GetShrinkData">
        <pd:type>com.tibco.plugin.jdbc.JDBCQueryActivity</pd:type>
        <pd:resourceType>ae.activities.JDBCQueryActivity</pd:resourceType>
        <pd:x>258</pd:x>
        <pd:y>241</pd:y>
        <config>
            <timeout>120</timeout>
            <commit>false</commit>
            <maxRows>%%Application/BatchSize%%</maxRows>
            <emptyStrAsNil>false</emptyStrAsNil>
            <processInSubsets>false</processInSubsets>
            <jdbcSharedConfig>/SharedResources/Connections/IRMA.sharedjdbc</jdbcSharedConfig>
            <statement>SELECT 
di.Adjustment_ID as AdjustmentNumber,
ai.EventTypeID as EventType,
(CAST(s.BusinessUnit_ID as varchar(10)) +'-'+ CAST(ai.EventTypeID as varchar(4)) +'-' + CAST(ai.QueueID as varchar(4))) as TransactionId,
di.Store_No as LocationNumber,
s.Store_Name as LocationName,
st.SubTeam_No as SubTeamNumber,
st.SubTeam_Name as SubTeamName,
case 
	when i.SubTeam_No = di.SubTeam_No
	then i.Item_Key
	else NULL
end as HostSubTeamNumber,
case 
	when i.SubTeam_No = di.SubTeam_No
	then i.Item_Description
	else NULL
end as HostSubTeamName,
ai.MessageTimestampUtc as CurrentDateTime
FROM amz.InventoryQueue as ai
JOIN dbo.ItemHistory as di on ai.KeyID = di.ItemHistoryID
JOIN Store as s on s.Store_No = di.Store_No
JOIN Item as i on i.Item_Key = di.Item_Key
JOIN SubTeam st on st.SubTeam_No = di.SubTeam_No
WHERE ai.Status in ('U','F')</statement>
            <wizardData/>
            <oraObjects/>
            <oraTables/>
            <QueryOutputCachedSchemaColumns>AdjustmentNumber</QueryOutputCachedSchemaColumns>
            <QueryOutputCachedSchemaDataTypes>4</QueryOutputCachedSchemaDataTypes>
            <QueryOutputCachedSchemaDataTypesName>int</QueryOutputCachedSchemaDataTypesName>
            <QueryOutputCachedSchemaStatus>RequiredElement</QueryOutputCachedSchemaStatus>
            <QueryOutputCachedSchemaColumns>EventType</QueryOutputCachedSchemaColumns>
            <QueryOutputCachedSchemaDataTypes>4</QueryOutputCachedSchemaDataTypes>
            <QueryOutputCachedSchemaDataTypesName>int</QueryOutputCachedSchemaDataTypesName>
            <QueryOutputCachedSchemaStatus>RequiredElement</QueryOutputCachedSchemaStatus>
            <QueryOutputCachedSchemaColumns>TransactionId</QueryOutputCachedSchemaColumns>
            <QueryOutputCachedSchemaDataTypes>12</QueryOutputCachedSchemaDataTypes>
            <QueryOutputCachedSchemaDataTypesName>varchar</QueryOutputCachedSchemaDataTypesName>
            <QueryOutputCachedSchemaStatus>OptionalElement</QueryOutputCachedSchemaStatus>
            <QueryOutputCachedSchemaColumns>LocationNumber</QueryOutputCachedSchemaColumns>
            <QueryOutputCachedSchemaDataTypes>4</QueryOutputCachedSchemaDataTypes>
            <QueryOutputCachedSchemaDataTypesName>int</QueryOutputCachedSchemaDataTypesName>
            <QueryOutputCachedSchemaStatus>RequiredElement</QueryOutputCachedSchemaStatus>
            <QueryOutputCachedSchemaColumns>LocationName</QueryOutputCachedSchemaColumns>
            <QueryOutputCachedSchemaDataTypes>12</QueryOutputCachedSchemaDataTypes>
            <QueryOutputCachedSchemaDataTypesName>varchar</QueryOutputCachedSchemaDataTypesName>
            <QueryOutputCachedSchemaStatus>RequiredElement</QueryOutputCachedSchemaStatus>
            <QueryOutputCachedSchemaColumns>SubTeamNumber</QueryOutputCachedSchemaColumns>
            <QueryOutputCachedSchemaDataTypes>4</QueryOutputCachedSchemaDataTypes>
            <QueryOutputCachedSchemaDataTypesName>int</QueryOutputCachedSchemaDataTypesName>
            <QueryOutputCachedSchemaStatus>RequiredElement</QueryOutputCachedSchemaStatus>
            <QueryOutputCachedSchemaColumns>SubTeamName</QueryOutputCachedSchemaColumns>
            <QueryOutputCachedSchemaDataTypes>12</QueryOutputCachedSchemaDataTypes>
            <QueryOutputCachedSchemaDataTypesName>varchar</QueryOutputCachedSchemaDataTypesName>
            <QueryOutputCachedSchemaStatus>OptionalElement</QueryOutputCachedSchemaStatus>
            <QueryOutputCachedSchemaColumns>HostSubTeamNumber</QueryOutputCachedSchemaColumns>
            <QueryOutputCachedSchemaDataTypes>4</QueryOutputCachedSchemaDataTypes>
            <QueryOutputCachedSchemaDataTypesName>int</QueryOutputCachedSchemaDataTypesName>
            <QueryOutputCachedSchemaStatus>OptionalElement</QueryOutputCachedSchemaStatus>
            <QueryOutputCachedSchemaColumns>HostSubTeamName</QueryOutputCachedSchemaColumns>
            <QueryOutputCachedSchemaDataTypes>12</QueryOutputCachedSchemaDataTypes>
            <QueryOutputCachedSchemaDataTypesName>varchar</QueryOutputCachedSchemaDataTypesName>
            <QueryOutputCachedSchemaStatus>OptionalElement</QueryOutputCachedSchemaStatus>
            <QueryOutputCachedSchemaColumns>CurrentDateTime</QueryOutputCachedSchemaColumns>
            <QueryOutputCachedSchemaDataTypes>93</QueryOutputCachedSchemaDataTypes>
            <QueryOutputCachedSchemaDataTypesName>datetime2</QueryOutputCachedSchemaDataTypesName>
            <QueryOutputCachedSchemaStatus>RequiredElement</QueryOutputCachedSchemaStatus>
        </config>
        <pd:inputBindings>
            <jdbcQueryActivityInput>
                <maxRows>
                    <xsl:value-of xmlns:xsl="http://www.w3.org/1999/XSL/Transform" select="$_globalVariables/ns:GlobalVariables/Application/BatchSize"/>
                </maxRows>
            </jdbcQueryActivityInput>
        </pd:inputBindings>
    </pd:activity>
    <pd:transition>
        <pd:from>Timer</pd:from>
        <pd:to>GetShrinkData</pd:to>
        <pd:lineType>Default</pd:lineType>
        <pd:lineColor>-16777216</pd:lineColor>
        <pd:conditionType>always</pd:conditionType>
    </pd:transition>
    <pd:transition>
        <pd:from>GetShrinkData</pd:from>
        <pd:to>BatchAndSendShrinkData</pd:to>
        <pd:lineType>Default</pd:lineType>
        <pd:lineColor>-16777216</pd:lineColor>
        <pd:conditionType>always</pd:conditionType>
    </pd:transition>
    <pd:transition>
        <pd:from>BatchAndSendShrinkData</pd:from>
        <pd:to>End</pd:to>
        <pd:lineType>Default</pd:lineType>
        <pd:lineColor>-16777216</pd:lineColor>
        <pd:conditionType>always</pd:conditionType>
    </pd:transition>
</pd:ProcessDefinition>